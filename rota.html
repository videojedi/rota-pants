<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xrota</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="rota.css">
</head>
<body>
    <div class="header-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <img src="logo.svg" alt="Xrota logo" style="height: 56px;">
        <button id="darkModeToggle" onclick="toggleDarkMode()" style="padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; background: var(--header-bg); color: #fff;">
            Dark Mode
        </button>
    </div>
    <img src="logo.svg" alt="Xrota" class="print-title" style="display: none; height: 48px; margin: 0 auto 5px;">
    <p class="print-week" id="printWeek" style="display: none; text-align: center; margin: 0 0 10px; font-size: 14px; font-weight: bold;"></p>



    <div class="info-bar">
        <div class="info-item">
            <label>Operating Hours</label>
            <span>08:00 - 20:30</span>
        </div>
        <div class="info-item">
            <label>Coverage Required</label>
            <span>1-2 (3 changeover)</span>
        </div>
        <div class="info-item">
            <label>Target Hours/Staff</label>
            <span>37.5 hrs</span>
        </div>
        <div class="info-item">
            <label>Total Staff Hours</label>
            <span id="totalHours">0</span>
        </div>
        <div class="info-item">
            <label>Coverage Status</label>
            <span id="coverageStatus">-</span>
        </div>
    </div>

    <div class="controls">
        <!-- Algorithm selector hidden for now - defaulting to V4 -->
        <div id="algorithmSelector" style="display: none; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500; color: var(--text-muted);">Algorithm:</label>
                <select id="algorithmSelect" onchange="changeAlgorithm(this.value)" style="padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 14px;">
                    <option value="v3">V3 - Backtracking</option>
                    <option value="v4" selected>V4 - 5-Week Rotation</option>
                </select>
            </div>
            <span id="algorithmInfo" style="font-size: 12px; color: var(--text-muted);">5-week rotation with consistent shift blocks</span>
        </div>
        <div class="action-btns" style="margin-bottom: 15px;">
            <button class="action-btn primary" onclick="generateBestFitRota()">Generate This Week</button>
            <button class="action-btn secondary" onclick="generate5Weeks()" style="background: #8e44ad;">Generate 5 Weeks</button>
            <button class="action-btn danger" onclick="openClearModal()">Clear</button>
            <button class="action-btn print" onclick="printRota()">Print Schedule</button>
            <button class="action-btn secondary" onclick="openImportExportModal()" style="background: #2c3e50;">Import/Export CSV</button>
            <button class="action-btn secondary" onclick="openPreferencesModal()" style="background: #16a085; display: none;">Staff Preferences</button>
        </div>
        <div id="generationResult" class="generation-result" style="display: none;"></div>
        <p id="algorithmDescription" style="margin: 10px 0; color: var(--text-muted); font-size: 13px;">5-week rotation: Weekend workers do E/L Sat-Sun + Float weekdays. Non-weekend staff get one shift type (E/M/L) all week. Each person works exactly 37.5 hours.</p>
        <h3>Shift Templates (click to select, then click cells)</h3>
        <div class="shift-templates">
            <button class="shift-btn" data-shift="early">Early (08:00-16:30)</button>
            <button class="shift-btn" data-shift="mid">Mid (10:00-18:30)</button>
            <button class="shift-btn" data-shift="late">Late (12:00-20:30)</button>
            <button class="shift-btn" data-shift="long">Long (08:00-20:30)</button>
            <button class="shift-btn" data-shift="floating">Floating (Flexible 7.5hrs)</button>
            <button class="shift-btn" data-shift="off">Day Off</button>
        </div>
        <p style="margin: 10px 0 0; color: var(--text-muted); font-size: 13px;">All shifts include 1 hour lunch break. Times shown are working hours.</p>
    </div>

    <div class="rota-container">
        <table id="rotaTable">
            <thead>
                <tr>
                    <th>Staff</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th class="weekend">Sat</th>
                    <th class="weekend">Sun</th>
                    <th>Weekly Hours</th>
                </tr>
            </thead>
            <tbody id="rotaBody">
            </tbody>
        </table>


    <div class="week-selector" style="background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;">
        <label style="font-weight: 500; color: var(--text-muted);">Week starting:</label>
        <span id="weekDisplay" style="font-size: 18px; font-weight: bold; color: var(--text-color); min-width: 280px;"></span>
        <button onclick="changeWeek(-1)" style="padding: 8px 10px; cursor: pointer; background: var(--header-bg); color: #fff; border: none; border-radius: 4px;">&lt; Prev</button>
        <button onclick="changeWeek(1)" style="padding: 8px 10px; cursor: pointer; background: var(--header-bg); color: #fff; border: none; border-radius: 4px;">Next &gt;</button>
        <button onclick="goToThisWeek()" style="padding: 8px 10px; cursor: pointer; background: #27ae60; color: #fff; border: none; border-radius: 4px; margin-left: 10px;">This Week</button>
        <button onclick="goToNextIssueWeek()" style="padding: 8px 10px; cursor: pointer; background: #e67e22; color: #fff; border: none; border-radius: 4px;">Next Issue</button>
    </div>    
    </div>
    <div class="coverage-detail">
        <h4>Hourly Coverage Graph</h4>
        <div class="graph-legend" style="display: flex; gap: 15px; margin-bottom: 15px; font-size: 12px; flex-wrap: wrap;">
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #27ae60; border-radius: 2px; margin-right: 5px;"></span>1-2 staff (ideal)</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #3498db; border-radius: 2px; margin-right: 5px;"></span>3 staff (weekday 08:00-16:30 only)</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #e74c3c; border-radius: 2px; margin-right: 5px;"></span>No coverage</span>
            <span><span style="display: inline-block; width: 12px; height: 12px; background: #e67e22; border-radius: 2px; margin-right: 5px;"></span>Over staffed</span>
        </div>
        <div id="coverageGraph" style="display: flex; gap: 10px; flex-wrap: nowrap;">
        </div>
    </div>

    <div class="shift-distribution" style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="margin-top: 0;">Shift Distribution - Last 5 Weeks</h4>
        <p style="margin: 0 0 15px; font-size: 13px; color: var(--text-muted);">
            Total shifts by type per person. Includes any manual changes made to the schedule.
        </p>
        <div id="shiftDistributionContainer" style="overflow-x: auto;">
            <table id="shiftDistributionTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background: var(--header-bg); color: #fff;">
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">Staff</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--early-bg); color: var(--early-text);">Early</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--mid-bg); color: var(--mid-text);">Mid</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--late-bg); color: var(--late-text);">Late</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--floating-bg); color: var(--floating-text);">Float</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--long-bg); color: var(--long-text);">Long</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">Total</th>
                        <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color); background: var(--weekend-bg); color: #fff;">Weekend Shifts</th>
                    </tr>
                </thead>
                <tbody id="shiftDistributionBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="print-notes" style="display: none;">
        <h4 style="margin: 0 0 5px; font-size: 11px;">Notes:</h4>
        <div style="border: 1px solid #ccc; min-height: 60px; border-radius: 4px;"></div>
    </div>

    <footer style="margin-top: 30px; padding: 20px; text-align: center; color: var(--text-muted); font-size: 14px;">
        Copyright 2026 <a href="https://videowalrus.com" target="_blank" style="color: #3498db; text-decoration: none;">Video Walrus Ltd</a>
    </footer>

    <div class="print-footer" style="display: none; justify-content: space-between;">
        <span id="printDate"></span>
        <span>Copyright 2026 Video Walrus Ltd - videowalrus.com</span>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 25px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--text-color);">Import / Export Data</h2>
                <button onclick="closeImportExportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--text-color); margin-bottom: 10px;">Export Data</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">Download all rota data including staff names, shifts for all weeks, and day-off patterns.</p>
                <button onclick="exportToCSV()" class="action-btn primary" style="width: 100%;">Download CSV</button>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">

            <div>
                <h3 style="color: var(--text-color); margin-bottom: 10px;">Import Data</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">Upload a CSV file to import rota data. This will replace all existing data.</p>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('csvFileInput').click()" class="action-btn secondary" style="width: 100%; margin-bottom: 10px;">Select CSV File</button>
                <div id="importPreview" style="display: none; margin-top: 15px;">
                    <p style="color: var(--text-color); font-weight: bold; margin-bottom: 10px;">Preview:</p>
                    <div id="importPreviewContent" style="background: var(--staff-row-bg); padding: 10px; border-radius: 5px; font-size: 12px; max-height: 150px; overflow-y: auto; color: var(--text-color);"></div>
                    <button onclick="confirmImport()" class="action-btn primary" style="width: 100%; margin-top: 10px;">Confirm Import</button>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">

            <div>
                <h3 style="color: var(--text-color); margin-bottom: 10px;">CSV Format</h3>
                <p style="color: var(--text-muted); font-size: 12px; line-height: 1.6;">
                    The CSV contains rows for each staff member per week:<br>
                    <code style="background: var(--staff-row-bg); padding: 2px 5px; border-radius: 3px;">week_start,staff_id,staff_name,mon,tue,wed,thu,fri,sat,sun</code><br><br>
                    Shift values: <code>early</code>, <code>mid</code>, <code>late</code>, <code>long</code>, <code>floating</code>, <code>off</code>, or empty
                </p>
            </div>
        </div>
    </div>

    <!-- Staff Preferences Modal -->
    <div id="preferencesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 25px; border-radius: 10px; max-width: 550px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--text-color);">Staff Preferences</h2>
                <button onclick="closePreferencesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: bold;">Select Staff Member:</label>
                <select id="prefStaffSelect" onchange="loadStaffPreference()" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); font-size: 14px;"></select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: bold;">Preferred Days Off:</label>
                <p style="margin: 0 0 10px; font-size: 12px; color: var(--text-muted);">Soft preference - algorithm will try to give these days off when possible</p>
                <div id="prefDaysOff" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: bold;">Shift Preferences:</label>
                <p style="margin: 0 0 10px; font-size: 12px; color: var(--text-muted);">1 = Avoid, 3 = Neutral, 5 = Prefer</p>
                <div id="prefShiftRatings"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: bold;">Unavailable Dates:</label>
                <p style="margin: 0 0 10px; font-size: 12px; color: var(--text-muted);">Hard constraint - will not be scheduled on these dates</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="date" id="prefUnavailableDate" style="flex: 1; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                    <button onclick="addUnavailableDate()" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">Add</button>
                </div>
                <ul id="prefUnavailableDatesList" style="list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto;"></ul>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: var(--text-color); font-weight: bold;">Notes:</label>
                <textarea id="prefNotes" rows="2" placeholder="Any additional notes..." style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); resize: vertical; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="saveCurrentPreference()" style="flex: 1; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Save Preferences</button>
                <button onclick="closePreferencesModal()" style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clear Data Modal -->
    <div id="clearModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); padding: 25px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: var(--text-color);">Clear Data</h2>
                <button onclick="closeClearModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>

            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">What would you like to clear?</p>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button onclick="clearThisWeek()" class="action-btn secondary" style="width: 100%; padding: 12px;">
                    Clear This Week Only
                    <span style="display: block; font-size: 11px; color: var(--text-muted); margin-top: 4px;">Remove all shifts for the current week</span>
                </button>

                <button onclick="clearAllData()" class="action-btn danger" style="width: 100%; padding: 12px;">
                    Clear All Data
                    <span style="display: block; font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Remove all weeks, staff names, and preferences</span>
                </button>
            </div>

            <button onclick="closeClearModal()" style="width: 100%; margin-top: 15px; padding: 10px; background: none; border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted); cursor: pointer;">Cancel</button>
        </div>
    </div>

    <script src="rota.js" defer></script>
</body>
</html>
